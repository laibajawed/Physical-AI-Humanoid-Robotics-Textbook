# Frontend API Contract
# Spec-4: ChatKit Frontend Integration
# Date: 2025-12-18
#
# This contract defines the API interface between the Docusaurus ChatKit frontend
# and the FastAPI backend for the Physical AI & Robotics textbook Q&A system.

openapi: 3.0.3
info:
  title: RAG Agent API - Frontend Contract
  description: |
    API contract for the ChatKit frontend integration with the RAG Agent backend.
    This document defines the endpoints, request/response schemas, and error codes
    that the frontend must handle.
  version: 1.0.0
  contact:
    name: Spec-4 ChatKit Frontend

servers:
  - url: http://localhost:8000
    description: Local development
  - url: https://your-backend.railway.app
    description: Production (Railway)

# =============================================================================
# CORS Configuration
# =============================================================================
# Backend must configure CORSMiddleware with these origins:
#
# Development:
#   - http://localhost:3000 (Docusaurus dev server)
#   - http://localhost:5173 (Vite dev server)
#
# Production:
#   - https://hackathon-i-physical-ai-humanoid-ro-dun.vercel.app
#
# Environment Variable:
#   CORS_ORIGINS=http://localhost:3000,http://localhost:5173,https://hackathon-i-physical-ai-humanoid-ro-dun.vercel.app
# =============================================================================

paths:
  # ===========================================================================
  # Chat Endpoint (Non-Streaming)
  # ===========================================================================
  /chat:
    post:
      operationId: submitChat
      summary: Submit a chat question
      description: |
        Ask a question about the Physical AI & Robotics textbook.
        Returns an AI-generated answer with source citations.

        **Modes**:
        - Default (full): Searches full book content via Qdrant
        - Selected-text: If `selected_text` is provided, answers grounded only in that text
      tags:
        - chat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              fullBookQuestion:
                summary: Full book search
                value:
                  query: "What is inverse kinematics?"
                  session_id: "550e8400-e29b-41d4-a716-446655440000"
              selectedTextQuestion:
                summary: Selected text mode
                value:
                  query: "Explain this concept"
                  selected_text: "Inverse kinematics is the process of determining joint angles..."
                  session_id: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                emptyQuery:
                  value:
                    error_code: "EMPTY_QUERY"
                    message: "Query cannot be empty"
                    request_id: "abc-123"
        '429':
          description: Rate limited
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds to wait before retrying
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Service unavailable
          headers:
            Retry-After:
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ===========================================================================
  # Streaming Chat Endpoint (SSE)
  # ===========================================================================
  /chat/stream:
    post:
      operationId: streamChat
      summary: Stream chat response via SSE
      description: |
        Stream answer generation via Server-Sent Events.

        **Event types**:
        - `delta`: Partial answer text
        - `sources`: Citation data (sent at end)
        - `done`: Stream complete
        - `error`: Error occurred
      tags:
        - chat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '200':
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string
                description: |
                  Server-Sent Events stream with JSON payloads.

                  Event format:
                  ```
                  data: {"delta": "partial text..."}

                  data: {"sources": [...], "metadata": {...}}

                  data: {"done": true}
                  ```
        '429':
          description: Rate limited

  # ===========================================================================
  # History Endpoint
  # ===========================================================================
  /history/{session_id}:
    get:
      operationId: getHistory
      summary: Get conversation history
      description: Retrieve conversation history for a session
      tags:
        - history
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the session
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: Maximum entries to return
      responses:
        '200':
          description: Conversation history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HistoryResponse'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ===========================================================================
  # Health Endpoint
  # ===========================================================================
  /health:
    get:
      operationId: healthCheck
      summary: Check service health
      description: Returns status of dependent services (Qdrant, Postgres)
      tags:
        - health
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

# =============================================================================
# Component Schemas
# =============================================================================
components:
  schemas:
    # -------------------------------------------------------------------------
    # Request Schemas
    # -------------------------------------------------------------------------
    ChatRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          minLength: 1
          maxLength: 32000
          description: The question to ask about the book
        selected_text:
          type: string
          maxLength: 64000
          nullable: true
          description: |
            Optional selected text for grounded Q&A.
            When provided, the answer is based only on this text (no Qdrant search).
        session_id:
          type: string
          format: uuid
          nullable: true
          description: Client-generated session ID (UUID v4)
        filters:
          $ref: '#/components/schemas/QueryFilters'

    QueryFilters:
      type: object
      nullable: true
      properties:
        source_url_prefix:
          type: string
          maxLength: 500
          nullable: true
          description: Filter results by URL prefix
        section:
          type: string
          maxLength: 200
          nullable: true
          description: Filter results by section name

    # -------------------------------------------------------------------------
    # Response Schemas
    # -------------------------------------------------------------------------
    ChatResponse:
      type: object
      required:
        - sources
        - metadata
        - session_id
      properties:
        answer:
          type: string
          nullable: true
          description: AI-generated response (null if error)
        fallback_message:
          type: string
          nullable: true
          description: Shown when answer is null
        sources:
          type: array
          items:
            $ref: '#/components/schemas/SourceCitation'
          description: Source citations
        metadata:
          $ref: '#/components/schemas/ResponseMetadata'
        session_id:
          type: string
          format: uuid
          description: Session identifier

    SourceCitation:
      type: object
      required:
        - source_url
        - title
        - section
        - chunk_position
        - similarity_score
        - snippet
      properties:
        source_url:
          type: string
          format: uri
          description: Full URL to book section
        title:
          type: string
          description: Document/chapter title
        section:
          type: string
          description: Section/heading name
        chunk_position:
          type: integer
          description: Position in source document
        similarity_score:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Retrieval similarity score
        snippet:
          type: string
          maxLength: 200
          description: First 200 characters of chunk

    ResponseMetadata:
      type: object
      required:
        - query_time_ms
        - retrieval_count
        - mode
        - low_confidence
        - request_id
      properties:
        query_time_ms:
          type: number
          description: Total processing time in milliseconds
        retrieval_count:
          type: integer
          description: Number of chunks retrieved
        mode:
          type: string
          enum:
            - full
            - selected_text
            - retrieval_only
            - no_results
          description: |
            Response mode:
            - full: Normal search with LLM answer
            - selected_text: Grounded in provided text
            - retrieval_only: No LLM, only search results
            - no_results: No relevant results found
        low_confidence:
          type: boolean
          description: True if similarity scores are 0.3-0.5
        request_id:
          type: string
          format: uuid
          description: Request ID for tracing

    HistoryResponse:
      type: object
      required:
        - session_id
        - entries
        - total_entries
      properties:
        session_id:
          type: string
          format: uuid
        entries:
          type: array
          items:
            $ref: '#/components/schemas/HistoryEntry'
        total_entries:
          type: integer

    HistoryEntry:
      type: object
      description: |
        Single conversation turn from backend.
        NOTE: Backend stores query+response pairs, NOT role+content.
        Frontend must transform to individual messages for UI display.
      required:
        - timestamp
        - query
        - response
      properties:
        timestamp:
          type: string
          format: date-time
          description: When the exchange occurred
        query:
          type: string
          description: User's question
        response:
          type: string
          description: Agent's answer
        sources:
          type: array
          items:
            $ref: '#/components/schemas/SourceCitation'
          description: Citations for the answer

    HealthResponse:
      type: object
      required:
        - status
        - timestamp
        - services
        - version
      properties:
        status:
          type: string
          enum:
            - healthy
            - degraded
            - unavailable
        timestamp:
          type: string
          format: date-time
        services:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/ServiceStatus'
        version:
          type: string

    ServiceStatus:
      type: object
      required:
        - name
        - status
      properties:
        name:
          type: string
        status:
          type: string
          enum:
            - healthy
            - unavailable
        latency_ms:
          type: number
        error:
          type: string

    # -------------------------------------------------------------------------
    # Error Schema
    # -------------------------------------------------------------------------
    ErrorResponse:
      type: object
      required:
        - error_code
        - message
        - request_id
      properties:
        error_code:
          type: string
          enum:
            - EMPTY_QUERY
            - QUERY_TOO_LONG
            - SELECTION_TOO_LONG
            - RATE_LIMITED
            - SESSION_NOT_FOUND
            - SERVICE_UNAVAILABLE
            - INTERNAL_ERROR
          description: Machine-readable error code
        message:
          type: string
          description: Human-readable error message
        request_id:
          type: string
          format: uuid
          description: Request ID for tracing
        details:
          type: object
          nullable: true
          additionalProperties: true
          description: Additional error context

# =============================================================================
# Environment Configuration
# =============================================================================
#
# IMPORTANT: Docusaurus does NOT use NEXT_PUBLIC_* variables (that's Next.js).
# Use docusaurus.config.ts customFields instead.
#
# Frontend Configuration (docusaurus.config.ts):
#   customFields: {
#     backendUrl: process.env.BACKEND_URL || 'http://localhost:8000',
#   }
#
#   Access in React components:
#     import useDocusaurusContext from '@docusaurus/useDocusaurusContext';
#     const { siteConfig } = useDocusaurusContext();
#     const backendUrl = siteConfig.customFields.backendUrl as string;
#
# Frontend Environment Variables (.env or Vercel):
#   BACKEND_URL: Backend API base URL
#     - Development: http://localhost:8000 (default if not set)
#     - Production: Set in Vercel environment settings
#
# Backend Environment Variables:
#   CORS_ORIGINS: Comma-separated list of allowed origins
#     - Must include all frontend origins
#     - NO WILDCARDS in production
#
# Example .env (frontend - local dev):
#   BACKEND_URL=http://localhost:8000
#
# Example Vercel Environment Variable (production):
#   BACKEND_URL=https://your-backend.railway.app
#
# Example .env (backend):
#   CORS_ORIGINS=http://localhost:3000,http://localhost:5173,https://hackathon-i-physical-ai-humanoid-ro-dun.vercel.app
# =============================================================================
